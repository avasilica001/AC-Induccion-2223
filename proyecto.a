;ESTADO		EQU
;EVENTO		EQU	
LED_R		EQU	P2.0
BUZZER		EQU	P2.1
MAS_BTN		EQU	P3.0
MENOS_BTN	EQU	P3.1
ONOFF_BTN	EQU	P3.2
SENSOR		EQU	P3.3
;ADC_TEMP	EQU	P5.0
DISPLAY		EQU	0X30
DP_A		EQU	P0.0
DP_B		EQU	P0.1
DP_C		EQU	P0.2
DP_D		EQU	P0.3
DP_E		EQU	P0.4
DP_F		EQU	P0.5
DP_G		EQU	P0.6
ESTADO		EQU	0X20
EVENTO		EQU	0X21
CONT1		EQU	0X2B
CONT2		EQU	0X2C
TICK100MS	EQU	0X22.0
MS100		EQU	0X23
IEN0		EQU	0XA8


	AJMP 	INICIO

;ORG 0X7B

INICIO:
	ACALL 	INICIALIZACIONES

BUCLE:
	ACALL 	MAQUINAESTADOS
	AJMP	BUCLE

INICIALIZACIONES:

; 	MOV	A,#12	Probar que debugea bien
	MOV	ESTADO,#0
	MOV	EVENTO,#0
	MOV 	CONT1,#0
	MOV 	CONT2,#0
	MOV 	MS100, #0
	CLR	A
	CLR	LED_R
	CLR	BUZZER
	CLR	MAS_BTN
	CLR	MENOS_BTN
	CLR	ONOFF_BTN
	CLR	SENSOR
	CLR	DISPLAY
	CLR 	TICK100MS
	CLR	DP_A
	CLR	DP_B
	CLR	DP_C
	CLR	DP_D 
	CLR	DP_E
	CLR	DP_F
	CLR	DP_G
	CLR	LED_R
	ACALL	ENCENDER_TIMER
;	CLR	ADC_TEMP
	RET


MAQUINAESTADOS:

	MOV	A,ESTADO
	RL	A
	MOV 	DPTR,#EST_TABL
	JMP 	@A+DPTR

EST_TABL:
	AJMP	ESTADO0
	AJMP	ESTADO1
	AJMP	ESTADO2


;***********************************************ESTADO 0 --> REPOSO
ESTADO0:

	ACALL	GEN_EVE0
	MOV	A,EVENTO
	RL 	A; ROTA ACUM A LA IZQ
	MOV 	DPTR,#EV0_TBL
	JMP 	@A+DPTR

EV0_TBL:

	AJMP 	EV00_ESPERA ;EVENTO VACIO
	AJMP 	EV01_PULSADOON ;EVENTO AL PULSAR EL BOTON ON

	

GEN_EVE0:
	;SI SE HA PULSADO EL BOTON DE ON
	JB 	ONOFF_BTN, CON00
	RET


EV00_ESPERA:
	RET

EV01_PULSADOON:
	MOV 	ESTADO,#01
	RET

CON00:
	MOV EVENTO,#01
	RET

;***********************************************ESTADO 1 --> BUZZER ENCENDIDO 200MS
ESTADO1:

	ACALL	GEN_EVE1
	MOV	A,EVENTO
	RL 	A; ROTA ACUM A LA IZQ
	MOV 	DPTR,#EV1_TBL
	JMP 	@A+DPTR

EV1_TBL:

	AJMP 	EV10_ESPERA ;EVENTO VACIO
	AJMP 	EV11_TERMINAR ;EVENTO AL PULSAR EL BOTON ON
	AJMP	EV12_SEGUIR

	

GEN_EVE1:
	ACALL	MOSTRAR_DP_0 ;SIN PARPADEO 
	SETB	LED_R
	;PÃŒTIDO
	SETB 	BUZZER
	MOV 	A, #0X2
	CLR	C
	SUBB	A, MS100
	;SE HA LLEGADO A LOS 200MS
	JZ	CON11
	JB 	TICK100MS,CON12
	MOV 	EVENTO,#0
	RET

EV10_ESPERA:
	RET

EV11_PULSADOON:
	RET

CON11:
	MOV EVENTO,#01
	RET

CON12:
	MOV EVENTO, #02
	RET

EV11_TERMINAR:
	CLR BUZZER
	MOV ESTADO,#02
        RET

EV12_SEGUIR:
 	CLR 	TICK100MS
	INC 	MS100
	RET
;***********************************************ESTADO 1 --> ENCENDIDO
ESTADO2:

        ACALL	GEN_EVE2
        MOV 	A,EVENTO
        RL 	A
        MOV 	DPTR,#EV2_TABL
        JMP 	@A+DPTR


EV2_TABL:
        
	;AJMP 	EV0
        ;AJMP 	EV11

GEN_EVE2:

	RET

EVE:

	;ACALL	PARPADEO_DP;SE INICIA EL TIMER15S Y SE TIENE EN CUENTA LOS 500MS ENCENDIDO Y 500MS APAGADO


MOSTRAR_DP_0:
	MOV A, #0
	ACALL BCD_7SEG
	MOV DISPLAY, A
	MOV P0, DISPLAY
	RET


BCD_7SEG:
	INC 	A
	MOVC 	A,@A+PC
	RET
	DB 	00111111b
	DB 	00000110B
	DB 	01011011B
	DB 	01001111B
	DB 	01100110b
	DB 	01101101B
	DB 	01111101B
	DB 	00000111B
	DB 	01111111B
	DB 	01100111B


ENCENDER_TIMER:			
	ORL 	IEN0,#10000010b
	MOV	TH0, #00111000b
	MOV 	TL0, #00111000b
	MOV 	CONT1,#0
	MOV 	CONT2,#0
	SETB 	TR0
	RET

APAGAR_TIMER:			
	ANL 	IEN0, #00000000b
        CLR 	TR0
	RET

INT_TIMER:	
	PUSH 	PSW
	PUSH 	ACC
	INC 	CONT1
	MOV 	A, #01111101b
	CLR 	C
	SUBB 	A, CONT1
	JNZ 	TIMERCON
	MOV 	CONT1, 	#0
	INC 	CONT2
	MOV 	A, #00001000b
	CLR 	C
	SUBB 	A, CONT2
	JNZ 	TIMERCON
	MOV 	CONT2, #0
	SETB 	TICK100MS
	;HAN PASADO 100MS
	POP 	ACC
	POP 	PSW
	RET

TIMERCON:
	POP 	ACC
	POP 	PSW
	RET



END


